<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title th:text="${product.productName} + ' | Lifesens'">å•†å“è©³ç´°</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</head>

<body>
	<!-- âœ… å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ -->
	<div th:replace="fragments/header.html :: headerFragment"></div>

	<div class="container mt-4">
		<div class="row">
			<!-- å•†å“ç”»åƒ -->
			<div class="col-md-6">
				<div th:if="${images != null}">
					<img th:each="img : ${images}" th:src="@{${img.imageUrl}}" class="img-fluid mb-3"
						style="max-height: 400px;">
				</div>
			</div>

			<!-- å•†å“æƒ…å ± -->
			<div class="col-md-6">
				<h2 th:text="${product.productName}">å•†å“å</h2>
				<p class="text-muted" th:text="${product.category.categoryName}">ã‚«ãƒ†ã‚´ãƒª</p>
				<h4 class="text-danger">Â¥<span th:text="${product.price}">ä¾¡æ ¼</span></h4>

				<div class="mb-3">
					<strong>èª¬æ˜:</strong>
					<p th:text="${product.description}">å•†å“èª¬æ˜</p>
				</div>

				<div class="mb-3">
					<strong>åœ¨åº«:</strong>
					<span th:text="${product.stockQuantity} + ' å€‹åœ¨åº«ã‚ã‚Š'">åœ¨åº«æƒ…å ±</span>
				</div>

				<!-- âœ… Ajaxã‚«ãƒ¼ãƒˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
				<form id="addToCartForm">
					<input type="hidden" name="productId" th:value="${product.productId}" />
					<input type="hidden" name="productName" th:value="${product.productName}" />
					<input type="hidden" name="price" th:value="${product.price}" />
					<input type="hidden" name="imageUrl" th:value="${images[0].imageUrl}" />
					<label for="quantity" class="form-label">æ•°é‡ï¼š</label>
					<input type="number" name="quantity" value="1" min="1" class="form-control mb-2"
						style="width: 120px;" />

					<button type="submit" class="btn btn-success">ğŸ›’ ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹</button>
				</form>

				<a href="/product-list" class="btn btn-link mt-3">â† å•†å“ä¸€è¦§ã«æˆ»ã‚‹</a>
			</div>
		</div>
	</div>

	<!-- âœ… ã‚«ãƒ¼ãƒˆOffcanvas -->
	<div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer" aria-labelledby="cartDrawerLabel">
		<div class="offcanvas-header">
			<h5 id="cartDrawerLabel">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ</h5>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="é–‰ã˜ã‚‹"></button>
		</div>
		<div class="offcanvas-body">
			<div th:replace="fragments/cart_offcanvas.html :: cartContent"></div>
		</div>
	</div>

	<!-- âœ… Ajaxå‡¦ç† -->
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			// âœ… ã‚«ãƒ¼ãƒˆè¿½åŠ  Ajax
			const form = document.getElementById("addToCartForm");
			if (form) {
				form.addEventListener("submit", function (e) {
					e.preventDefault();
					const formData = new FormData(form);

					fetch("/cart/add", {
						method: "POST",
						body: new URLSearchParams(formData),
					})
						.then(res => res.json())
						.then(data => {
							if (data.status === "OK") {
								// è¿½åŠ æˆåŠŸå¾Œã«ã‚«ãƒ¼ãƒˆå†…å®¹ã‚’æ›´æ–°
								refreshCartDrawer(data.cartSize);
							}
						})
						.catch(err => console.error("ã‚«ãƒ¼ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:", err));
				});
			}

			// âœ… å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆAjaxï¼‰
			document.addEventListener("click", function (e) {
				if (e.target.classList.contains("remove-item-btn")) {
					const productId = e.target.getAttribute("data-id");
					fetch("/cart/remove-ajax", {
						method: "POST",
						headers: {"Content-Type": "application/x-www-form-urlencoded"},
						body: `productId=${productId}`
					})
						.then(res => res.json())
						.then(data => {
							if (data.status === "OK") {
								refreshCartDrawer(data.cartSize);
							}
						})
						.catch(err => console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err));
				}
			});

			// âœ… ã‚«ãƒ¼ãƒˆå†…å®¹ã‚’å†å–å¾—ã—ã€Offcanvasã‚’æ›´æ–°
			function refreshCartDrawer(cartSize) {
				fetch("/cart/fragment")
					.then(res => res.text())
					.then(html => {
						document.querySelector(".offcanvas-body").innerHTML = html;
						document.querySelector("#cartItemCount").innerText = cartSize;

						const drawer = new bootstrap.Offcanvas(document.getElementById("cartDrawer"));
						drawer.show();
					});
			}
		});
	</script>
</body>

</html>
